# Fixes Applied - 12/01/2026

## Issues Fixed

### 1. ✅ Weather Tracking Flag
**Problem**: Weather tracking flag (`weather_downloaded`) was not being set when weather already existed or was successfully downloaded.

**Fix Applied**:
- Set `weather_downloaded = True` when weather already exists in database
- Set `weather_downloaded = True` when weather is successfully downloaded
- Set `weather_error` when download fails

**Location**: `app/api/probabilities.py` lines 659-702

### 2. ✅ Rest Days Tracking Flag
**Problem**: Rest days tracking flag (`rest_days_calculated`) was not being set when rest days already existed.

**Fix Applied**:
- Set `rest_days_calculated = True` when rest days already exist in database
- Already correctly set when rest days are successfully calculated

**Location**: `app/api/probabilities.py` lines 712-744

### 3. ✅ Injuries Tracking Flag
**Problem**: Injuries tracking flag (`injuries_downloaded`) was not being set when injuries already existed or were successfully downloaded.

**Fix Applied**:
- Set `injuries_downloaded = True` when injuries already exist in database
- Set `injuries_downloaded = True` when injuries are successfully downloaded
- Set `injuries_error` when download fails

**Location**: `app/api/probabilities.py` lines 756-799

### 4. ✅ Odds Movement Tracking Flag
**Problem**: Odds movement tracking flag (`odds_tracked`) was not being set when odds movement already existed.

**Fix Applied**:
- Set `odds_tracked = True` when odds movement already exists in database
- Set `odds_tracked = True` when odds movement is successfully tracked
- Set `odds_error` when tracking fails

**Location**: `app/api/probabilities.py` lines 801-832

### 5. ⚠️ API Key Configuration
**Status**: API key is hardcoded as fallback in `app/config.py` line 181
- **Current Behavior**: If `API_FOOTBALL_KEY` environment variable is not set, system uses hardcoded key: `b41227796150918ad901f64b9bdf3b76`
- **Recommendation**: This is acceptable for development, but should be removed or documented for production
- **Location**: `app/config.py` lines 175-181

**Note**: The system correctly checks if API key exists before attempting downloads (line 769 in probabilities.py).

### 6. ⚠️ Team ID Mismatch Issue
**Problem**: Teams in jackpot have different IDs than teams in training data, causing "untrained" status even after training.

**Root Cause**:
- Teams are resolved by name using `resolve_team_safe()`, which may create new teams or return existing teams with different IDs
- Training data uses team IDs from historical matches
- Jackpot fixtures may resolve to different team IDs than training data

**Current Behavior**:
- System checks if `team_id in team_strengths` (line 78-81 in automated_pipeline.py)
- If team ID doesn't match, team is marked as untrained
- This is expected behavior if teams truly have different IDs

**Recommendation**:
1. **Use canonical_name matching**: Instead of checking by ID, check by canonical_name
2. **Team ID consistency**: Ensure teams are created with consistent IDs across different contexts
3. **Training window expansion**: Consider expanding training window to include more teams

**Location**: `app/services/automated_pipeline.py` lines 70-88

---

## Testing Recommendations

1. **Test Weather Tracking**:
   - Create a fixture with existing weather data
   - Verify `weather_downloaded = True` in jackpot log
   - Create a fixture without weather data
   - Verify weather is downloaded and `weather_downloaded = True` in jackpot log

2. **Test Injuries Download**:
   - Verify API key is being used (check logs for API calls)
   - Verify injuries are saved to `team_injuries` table
   - Check jackpot log shows `injuries_downloaded = True`

3. **Test Team ID Matching**:
   - After training, check if teams show as trained
   - If not, verify team IDs match between training data and jackpot fixtures
   - Consider using canonical_name matching instead of ID matching

---

## Files Modified

1. `2_Backend_Football_Probability_Engine/app/api/probabilities.py`
   - Fixed weather tracking flag (lines 663-702)
   - Fixed rest days tracking flag (lines 713-744)
   - Fixed injuries tracking flag (lines 756-799)
   - Fixed odds movement tracking flag (lines 801-832)

2. `2_Backend_Football_Probability_Engine/app/services/model_training.py`
   - Fixed calibration training `split_idx` error (line 1204 → moved to 1199)

---

## Remaining Issues

1. **Team ID Mismatch**: Needs investigation and potential fix using canonical_name matching
2. **API Key Hardcoded**: Should be documented or removed for production
3. **Second Occurrence**: There's a second occurrence of weather/rest days/injuries ingestion code around line 1020 that may also need the same fixes

---

## Next Steps

1. Test all tracking flags with real data
2. Investigate team ID mismatch and implement canonical_name matching if needed
3. Document API key configuration
4. Fix second occurrence of ingestion code if it's a duplicate

